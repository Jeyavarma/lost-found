"use strict";exports.id=380,exports.ids=[380],exports.modules={23673:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(23339).A)("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]])},63090:(a,b,c)=>{c.d(b,{A:()=>D});var d=c(21124),e=c(38301),f=c(71179),g=c(81296),h=c(8849),i=c(58620),j=c(47268),k=c(40280),l=c(88386),m=c(78660),n=c(47089),o=c(18310),p=c(19217),q=c(45119),r=c(22544),s=c(36736),t=c(50849),u=c(23167),v=c(95907),w=c(98201),x=c(7629),y=c(674),z=c(88285),A=c(60637);function B({isOpen:a,onClose:b,onSelectUser:c,currentUserId:g}){let[h,i]=(0,e.useState)(""),[j,k]=(0,e.useState)([]),[l,m]=(0,e.useState)(!1);return(0,d.jsx)(w.lG,{open:a,onOpenChange:b,children:(0,d.jsxs)(w.Cf,{className:"max-w-md",children:[(0,d.jsx)(w.c7,{children:(0,d.jsxs)(w.L3,{className:"flex items-center gap-2",children:[(0,d.jsx)(f.A,{className:"w-5 h-5"}),"Start New Chat"]})}),(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsx)(z.A,{className:"absolute left-3 top-3 w-4 h-4 text-gray-400"}),(0,d.jsx)(x.p,{placeholder:"Search users by name or email...",value:h,onChange:a=>i(a.target.value),className:"pl-10"})]}),h.length<2&&(0,d.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"Type at least 2 characters to search for users"}),l&&(0,d.jsx)("div",{className:"text-center py-4",children:(0,d.jsx)("div",{className:"animate-spin w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"})}),(0,d.jsx)("div",{className:"max-h-60 overflow-y-auto space-y-2",children:j.map(a=>(0,d.jsxs)("div",{className:"flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer",onClick:()=>{c(a),b(),i(""),k([])},children:[(0,d.jsx)(y.eu,{className:"w-10 h-10",children:(0,d.jsx)(y.q5,{className:"bg-blue-100 text-blue-600",children:a.name.split(" ").map(a=>a[0]).join("").toUpperCase()})}),(0,d.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,d.jsx)("p",{className:"font-medium text-gray-900 truncate",children:a.name}),(0,d.jsx)("p",{className:"text-sm text-gray-500 truncate",children:a.email}),(0,d.jsx)("p",{className:"text-xs text-gray-400 capitalize",children:a.role})]}),(0,d.jsx)(p.$,{size:"sm",variant:"outline",children:(0,d.jsx)(f.A,{className:"w-4 h-4"})})]},a._id))}),h.length>=2&&!l&&0===j.length&&(0,d.jsxs)("p",{className:"text-sm text-gray-500 text-center py-4",children:['No users found matching "',h,'"']})]})]})})}var C=c(43567);function D(){let[a,b]=(0,e.useState)(!1),[c,w]=(0,e.useState)(!1),[x,y]=(0,e.useState)(!1),[z,D]=(0,e.useState)(null),[E,F]=(0,e.useState)(!1),[G,H]=(0,e.useState)(""),[I,J]=(0,e.useState)(!1),[K,L]=(0,e.useState)(0),[M,N]=(0,e.useState)({status:"disconnected",retryCount:0}),[O,P]=(0,e.useState)(!0),[Q,R]=(0,e.useState)(null),[S,T]=(0,e.useState)(!1),[U,V]=(0,e.useState)(!1),W=(0,e.useRef)(),X=(0,e.useRef)();(0,e.useCallback)(async()=>{try{R(null),await Y(),await _(),$()}catch(a){R("Failed to initialize chat system"),console.error("Chat initialization error:",a)}},[]);let Y=(0,e.useCallback)(async()=>{try{N(a=>({...a,status:"reconnecting"}));let a=C.b.connect();if(!a)throw Error("Failed to create socket connection");a.on("connect",()=>{N({status:"connected",lastConnected:Date.now(),retryCount:0}),R(null)}),a.on("disconnect",()=>{N(a=>({...a,status:"disconnected"})),Z()}),a.on("connect_error",a=>{N(a=>({...a,status:"error",retryCount:a.retryCount+1})),R(`Connection failed: ${a.message}`),Z()}),a.on("new_message",a=>{a.senderId!==G&&(L(a=>a+1),aa(a))})}catch(a){N(a=>({...a,status:"error",retryCount:a.retryCount+1})),R("Connection failed"),Z()}},[G]),Z=(0,e.useCallback)(()=>{W.current&&clearTimeout(W.current),W.current=setTimeout(()=>{M.retryCount<5&&Y()},Math.min(1e3*Math.pow(2,M.retryCount),3e4))},[M.retryCount,Y]),$=(0,e.useCallback)(()=>{X.current&&clearTimeout(X.current),X.current=setInterval(()=>{let a=C.b.getSocket();a?.connected?a.emit("ping"):N(a=>({...a,status:"disconnected"}))},3e4)},[]),_=(0,e.useCallback)(async()=>{try{let a=(0,t.getAuthToken)(),b=await fetch(`${A.f}/api/chat/rooms`,{headers:{Authorization:`Bearer ${a}`}});if(b.ok){let a=await b.json();J(a.length>0);let c=a.reduce((a,b)=>a+(b.unreadCount||0),0);L(c)}}catch(a){console.error("Failed to load chat rooms:",a)}},[]),aa=(0,e.useCallback)(a=>{O&&"Notification"in window&&"granted"===Notification.permission&&new Notification("New Message",{body:a.content,icon:"/favicon.ico",tag:"chat-message"})},[O]),ab=(0,e.useCallback)(async()=>{"Notification"in window&&P("granted"===await Notification.requestPermission())},[]),ac=(0,e.useCallback)(a=>{D(a),L(b=>Math.max(0,b-(a.unreadCount||0)))},[]),ad=(0,e.useCallback)(()=>{D(null)},[]),ae=(0,e.useCallback)(async a=>{try{let b=(0,t.getAuthToken)(),c=await fetch(`${A.f}/api/chat/direct`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`},body:JSON.stringify({otherUserId:a._id})});if(c.ok){let a=await c.json();D(a),_()}else R("Failed to start chat")}catch(a){R("Failed to start chat"),console.error("Start chat error:",a)}},[]),af=(0,e.useCallback)(()=>{R("Please login to start chatting"),setTimeout(()=>R(null),3e3)},[]);return E||S||I||Q?(0,d.jsxs)(s.Bc,{children:[!a&&(0,d.jsxs)(s.m_,{children:[(0,d.jsx)(s.k$,{asChild:!0,children:(0,d.jsx)(p.$,{onClick:()=>{S?af():(b(!0),ab())},className:`fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg z-50 p-0 transition-all duration-300 ${"connected"===M.status?"bg-blue-600 hover:bg-blue-700":"bg-gray-500 hover:bg-gray-600"}`,"aria-label":"Open chat",children:(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsx)(f.A,{className:"w-6 h-6 text-white"}),K>0&&(0,d.jsx)(r.E,{className:"absolute -top-2 -right-2 w-5 h-5 p-0 flex items-center justify-center bg-red-500 text-white text-xs","aria-label":`${K} unread messages`,children:K>99?"99+":K}),"disconnected"===M.status&&(0,d.jsx)(g.A,{className:"absolute -bottom-1 -right-1 w-3 h-3 text-red-500 bg-white rounded-full"})]})})}),(0,d.jsx)(s.ZI,{side:"left",children:(0,d.jsx)("p",{children:S?"Login to chat":"connected"===M.status?"Open messages":"Chat offline"})})]}),a&&(0,d.jsx)("div",{className:`fixed bottom-6 right-6 z-50 transition-all duration-300 ${x?"w-96 h-[600px] md:w-[500px] md:h-[700px]":c?"w-80 h-12":"w-80 h-96 md:w-96 md:h-[500px]"}`,children:(0,d.jsxs)(q.Zp,{className:"h-full shadow-xl border-2 flex flex-col",children:[(0,d.jsx)(q.aR,{className:"p-3 bg-blue-600 text-white rounded-t-lg flex-shrink-0",children:(0,d.jsxs)("div",{className:"flex items-center justify-between",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,d.jsx)(q.ZB,{className:"text-sm font-medium truncate",children:z?z.itemId?.title||"Direct Chat":"Messages"}),!z&&(0,d.jsx)(p.$,{variant:"ghost",size:"sm",onClick:()=>V(!0),className:"text-white hover:bg-blue-700 p-1 h-5 w-5","aria-label":"Start new chat",children:(0,d.jsx)(h.A,{className:"w-3 h-3"})}),(0,d.jsx)("div",{className:"flex items-center gap-1",children:"connected"===M.status?(0,d.jsx)(i.A,{className:"w-3 h-3 text-green-300"}):"reconnecting"===M.status?(0,d.jsx)("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):(0,d.jsx)(g.A,{className:"w-3 h-3 text-red-300"})}),(0,d.jsx)(p.$,{variant:"ghost",size:"sm",onClick:()=>P(!O),className:"text-white hover:bg-blue-700 p-1 h-5 w-5","aria-label":O?"Disable notifications":"Enable notifications",children:O?(0,d.jsx)(j.A,{className:"w-3 h-3"}):(0,d.jsx)(k.A,{className:"w-3 h-3"})})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1 flex-shrink-0",children:[(0,d.jsx)(p.$,{variant:"ghost",size:"sm",onClick:()=>y(!x),className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":x?"Restore":"Maximize",children:x?(0,d.jsx)(l.A,{className:"w-3 h-3"}):(0,d.jsx)(m.A,{className:"w-3 h-3"})}),(0,d.jsx)(p.$,{variant:"ghost",size:"sm",onClick:()=>w(!c),className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":c?"Restore":"Minimize",children:(0,d.jsx)(l.A,{className:"w-3 h-3"})}),(0,d.jsx)(p.$,{variant:"ghost",size:"sm",onClick:()=>{b(!1),D(null),w(!1),y(!1)},className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":"Close chat",children:(0,d.jsx)(n.A,{className:"w-3 h-3"})})]})]})}),Q&&(0,d.jsxs)("div",{className:"p-2 bg-red-50 border-b border-red-200 flex items-center gap-2 flex-shrink-0",children:[(0,d.jsx)(o.A,{className:"w-4 h-4 text-red-500"}),(0,d.jsx)("span",{className:"text-sm text-red-700",children:Q}),(0,d.jsx)(p.$,{variant:"ghost",size:"sm",onClick:()=>R(null),className:"ml-auto p-1 h-5 w-5 text-red-500 hover:bg-red-100",children:(0,d.jsx)(n.A,{className:"w-3 h-3"})})]}),!c&&(0,d.jsx)(q.Wu,{className:"p-0 flex-1 overflow-hidden",children:S?(0,d.jsxs)("div",{className:"p-4 text-center",children:[(0,d.jsx)(f.A,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),(0,d.jsx)("h3",{className:"font-medium text-gray-900 mb-2",children:"Login Required"}),(0,d.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"Please login to start chatting with other users"}),(0,d.jsx)(p.$,{onClick:()=>window.location.href="/login",className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Login"})]}):z?(0,d.jsx)(v.A,{room:z,currentUserId:G,onBack:ad}):(0,d.jsx)(u.A,{onSelectRoom:ac,currentUserId:G})})]})}),(0,d.jsx)(B,{isOpen:U,onClose:()=>V(!1),onSelectUser:ae,currentUserId:G})]}):null}}};