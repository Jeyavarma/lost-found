"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1309],{373:(e,t,s)=>{s.d(t,{f:()=>a});let a="https://lost-found-79xn.onrender.com"},3637:(e,t,s)=>{s.d(t,{A:()=>j});var a=s(5155),i=s(2115),n=s(3209),r=s(7003),l=s(6170),o=s(7346),c=s(7812),d=s(3884),h=s(5626),u=s(501),m=s(5229),g=s(8085),f=s(7355),x=s(373),p=s(8209),v=s(1233);function j(e){let{room:t,onClose:s,onBack:j,currentUserId:w}=e,[y,N]=(0,i.useState)([]),[b,k]=(0,i.useState)([]),[I,_]=(0,i.useState)(""),[S,C]=(0,i.useState)(!0),[A,M]=(0,i.useState)(!1),[T,E]=(0,i.useState)(navigator.onLine),q=(0,i.useRef)(null),R=f.b.getSocket(),z=t.participants.find(e=>e.userId._id!==w);(0,i.useEffect)(()=>{D(),F(),R&&(R.emit("join_room",t._id),R.on("new_message",e=>{N(t=>[...t,e]),e.clientMessageId&&k(t=>t.filter(t=>t.id!==e.clientMessageId)),e.senderId._id!==w&&document.hidden&&v.tk.showChatNotification(e.senderId.name,e.content,t._id,t.itemId.title),Q()}),R.on("reaction_added",e=>{N(t=>t.map(t=>t._id===e.messageId?{...t,reactions:e.reactions}:t))}),R.on("reaction_removed",e=>{N(t=>t.map(t=>t._id===e.messageId?{...t,reactions:e.reactions}:t))}),R.on("messages_read",e=>{N(t=>t.map(t=>e.messageIds.includes(t._id)?{...t,readBy:[...t.readBy||[],{userId:e.userId,readAt:new Date().toISOString()}]}:t))}));let e=()=>E(!0),s=()=>E(!1);return window.addEventListener("online",e),window.addEventListener("offline",s),()=>{R&&(R.emit("leave_room",t._id),R.off("new_message")),window.removeEventListener("online",e),window.removeEventListener("offline",s)}},[t._id,R]),(0,i.useEffect)(()=>{Q()},[y]),(0,i.useEffect)(()=>{v.tk.initialize()},[]),(0,i.useEffect)(()=>{let e=y.filter(e=>{var t;return e.senderId._id!==w&&!(null==(t=e.readBy)?void 0:t.some(e=>e.userId===w))}).map(e=>e._id);e.length>0&&R&&R.emit("mark_read",{messageIds:e})},[y,w,R]);let D=async()=>{try{let e=(0,p.getAuthToken)(),s=await fetch("".concat(x.f,"/api/chat/room/").concat(t._id,"/messages"),{headers:{Authorization:"Bearer ".concat(e)}});if(s.ok){let e=await s.json();N(e)}}catch(e){console.error("Failed to load messages:",e)}finally{C(!1)}},F=()=>{k(f.b.getPendingMessages(t._id))},P=async()=>{if(I.trim()&&!A){M(!0);try{let e={id:f.b.sendMessage(t._id,I.trim(),"text",e=>{"failed"===e&&F()}),roomId:t._id,content:I.trim(),type:"text",timestamp:Date.now(),status:"pending",retryCount:0};k(t=>[...t,e]),_("")}catch(e){console.error("Failed to send message:",e)}finally{M(!1)}}},B=async()=>{if(z)try{let e=(0,p.getAuthToken)();(await fetch("".concat(x.f,"/api/chat/block/").concat(z.userId._id),{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({reason:"Blocked from chat"})})).ok&&(alert("User blocked successfully"),null==s||s())}catch(e){console.error("Block user error:",e)}},L=e=>{var t;return(null==(t=e.readBy)?void 0:t.some(e=>e.userId!==w))||!1},Q=()=>{var e;null==(e=q.current)||e.scrollIntoView({behavior:"smooth"})};return(0,a.jsxs)(n.Zp,{className:"h-full flex flex-col",children:[(0,a.jsx)(n.aR,{className:"pb-3 border-b",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(r.$,{variant:"ghost",size:"sm",onClick:j||s,children:(0,a.jsx)(h.A,{className:"w-4 h-4"})}),t.itemId.imageUrl&&(0,a.jsx)("img",{src:t.itemId.imageUrl,alt:t.itemId.title,className:"w-10 h-10 rounded-lg object-cover"}),(0,a.jsxs)("div",{children:[(0,a.jsx)(n.ZB,{className:"text-lg",children:t.itemId.title}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,a.jsx)(c.E,{variant:"outline",children:t.itemId.category}),(0,a.jsx)("span",{children:"•"}),(0,a.jsxs)("span",{children:["with ",null==z?void 0:z.userId.name]})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.$,{variant:"ghost",size:"sm",onClick:B,title:"Block User",children:(0,a.jsx)(u.A,{className:"w-4 h-4"})}),s&&(0,a.jsx)(r.$,{variant:"ghost",size:"sm",onClick:s,children:(0,a.jsx)(m.A,{className:"w-4 h-4"})})]})]})}),(0,a.jsxs)(n.Wu,{className:"flex-1 p-0",children:[(0,a.jsx)(o.F,{className:"h-96 p-4",children:S?(0,a.jsx)("div",{className:"flex justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})}):(0,a.jsxs)("div",{className:"space-y-4",children:[y.map(e=>{let t=e.senderId._id===w;return(0,a.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"flex items-start gap-2 max-w-[70%] ".concat(t?"flex-row-reverse":""),children:[!t&&(0,a.jsx)(d.eu,{className:"w-8 h-8",children:(0,a.jsx)(d.q5,{className:"text-xs",children:e.senderId.name.charAt(0)})}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"rounded-lg px-3 py-2 ".concat(t?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:[(0,a.jsx)("p",{className:"text-sm",children:e.content}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsx)("p",{className:"text-xs ".concat(t?"text-blue-100":"text-gray-500"),children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),t&&(0,a.jsx)("span",{className:"text-xs ".concat(L(e)?"text-blue-200":"text-blue-300"),children:L(e)?"✓✓":"✓"})]})]}),e.reactions&&e.reactions.length>0&&(0,a.jsx)("div",{className:"flex gap-1 mt-1",children:e.reactions.map((e,t)=>(0,a.jsx)("span",{className:"text-xs bg-gray-100 px-1 rounded",children:e.emoji},t))})]})]})},e._id)}),b.map(e=>(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("div",{className:"flex items-start gap-2 max-w-[70%] flex-row-reverse",children:(0,a.jsxs)("div",{className:"bg-blue-400 text-white rounded-lg px-3 py-2 opacity-70",children:[(0,a.jsx)("p",{className:"text-sm",children:e.content}),(0,a.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[(0,a.jsx)("p",{className:"text-xs text-blue-100",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,a.jsxs)("span",{className:"text-xs text-blue-200",children:["pending"===e.status&&"⏳","sending"===e.status&&"\uD83D\uDCE4","failed"===e.status&&"❌"]})]})]})})},e.id)),(0,a.jsx)("div",{ref:q})]})}),(0,a.jsxs)("div",{className:"border-t p-4",children:[!T&&(0,a.jsx)("div",{className:"mb-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"\uD83D\uDCE1 You're offline. Messages will be sent when connection is restored."}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(l.p,{placeholder:T?"Type a message...":"Type a message (will send when online)...",value:I,onChange:e=>_(e.target.value),onKeyPress:e=>"Enter"===e.key&&P(),disabled:A,className:"flex-1"}),(0,a.jsx)(r.$,{onClick:P,disabled:!I.trim()||A,size:"sm",children:A?(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):(0,a.jsx)(g.A,{className:"w-4 h-4"})})]})]})]})]})}},3884:(e,t,s)=>{s.d(t,{eu:()=>l,q5:()=>o});var a=s(5155),i=s(2115),n=s(7870),r=s(5016);let l=i.forwardRef((e,t)=>{let{className:s,...i}=e;return(0,a.jsx)(n.bL,{ref:t,className:(0,r.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...i})});l.displayName=n.bL.displayName,i.forwardRef((e,t)=>{let{className:s,...i}=e;return(0,a.jsx)(n._V,{ref:t,className:(0,r.cn)("aspect-square h-full w-full",s),...i})}).displayName=n._V.displayName;let o=i.forwardRef((e,t)=>{let{className:s,...i}=e;return(0,a.jsx)(n.H4,{ref:t,className:(0,r.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...i})});o.displayName=n.H4.displayName},4969:(e,t,s)=>{s.d(t,{A:()=>m});var a=s(5155),i=s(2115),n=s(3209),r=s(7003),l=s(7812),o=s(3884),c=s(7346),d=s(5937),h=s(373),u=s(8209);function m(e){let{onSelectRoom:t,currentUserId:s}=e,[m,g]=(0,i.useState)([]),[f,x]=(0,i.useState)(!0);(0,i.useEffect)(()=>{p()},[]);let p=async()=>{try{let e=(0,u.getAuthToken)(),t=await fetch("".concat(h.f,"/api/chat/rooms"),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();g(Array.isArray(e)?e:[])}else g([])}catch(e){console.error("Failed to load chat rooms:",e)}finally{x(!1)}};return f?(0,a.jsxs)(n.Zp,{className:"h-full",children:[(0,a.jsx)(n.aR,{children:(0,a.jsxs)(n.ZB,{className:"flex items-center gap-2",children:[(0,a.jsx)(d.A,{className:"w-5 h-5"}),"Messages"]})}),(0,a.jsx)(n.Wu,{children:(0,a.jsx)("div",{className:"flex justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})})})]}):(0,a.jsxs)(n.Zp,{className:"h-full",children:[(0,a.jsx)(n.aR,{children:(0,a.jsxs)(n.ZB,{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(d.A,{className:"w-5 h-5"}),"Messages"]}),(0,a.jsx)(l.E,{variant:"secondary",children:m.length})]})}),(0,a.jsx)(n.Wu,{className:"p-0",children:0===m.length?(0,a.jsxs)("div",{className:"text-center py-8 px-4",children:[(0,a.jsx)(d.A,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"font-medium text-gray-900 mb-2",children:"No conversations yet"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:'Start a conversation by viewing an item and clicking "Contact"'})]}):(0,a.jsx)(c.F,{className:"h-96",children:(0,a.jsx)("div",{className:"space-y-1 p-2",children:m.filter(e=>e&&e._id).map(e=>{var i,n,c,d,h,u,m;let g=e.participants.find(e=>e.userId._id!==s);return(0,a.jsx)(r.$,{variant:"ghost",className:"w-full h-auto p-3 justify-start hover:bg-gray-50",onClick:()=>t(e),children:(0,a.jsxs)("div",{className:"flex items-center gap-3 w-full",children:[(null==(i=e.itemId)?void 0:i.imageUrl)?(0,a.jsx)("img",{src:e.itemId.imageUrl,alt:(null==(n=e.itemId)?void 0:n.title)||"Item",className:"w-12 h-12 rounded-lg object-cover flex-shrink-0",onError:e=>{e.currentTarget.style.display="none"}}):(0,a.jsx)(o.eu,{className:"w-12 h-12 flex-shrink-0",children:(0,a.jsx)(o.q5,{children:(null==(d=e.itemId)||null==(c=d.title)?void 0:c.charAt(0))||"C"})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)("h4",{className:"font-medium text-sm truncate",children:(null==(h=e.itemId)?void 0:h.title)||"Direct Chat"}),e.lastMessage&&(0,a.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:(e=>{let t=new Date(e),s=(new Date().getTime()-t.getTime())/36e5;if(s<1){let e=Math.floor(60*s);return"".concat(e,"m ago")}{if(s<24)return"".concat(Math.floor(s),"h ago");let e=Math.floor(s/24);return"".concat(e,"d ago")}})(e.lastMessage.timestamp)})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(null==(u=e.itemId)?void 0:u.category)&&(0,a.jsx)(l.E,{variant:"outline",className:"text-xs",children:e.itemId.category}),(0,a.jsxs)("span",{className:"text-xs text-gray-500",children:["with ",(null==g||null==(m=g.userId)?void 0:m.name)||"User"]})]}),e.lastMessage&&(0,a.jsx)("p",{className:"text-xs text-gray-600 truncate",children:e.lastMessage.content})]})]})},e._id)})})})})]})}},6170:(e,t,s)=>{s.d(t,{p:()=>r});var a=s(5155),i=s(2115),n=s(5016);let r=i.forwardRef((e,t)=>{let{className:s,type:i,...r}=e;return(0,a.jsx)("input",{type:i,className:(0,n.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:t,...r})});r.displayName="Input"},7346:(e,t,s)=>{s.d(t,{F:()=>l});var a=s(5155),i=s(2115),n=s(9034),r=s(5016);let l=i.forwardRef((e,t)=>{let{className:s,children:i,...l}=e;return(0,a.jsxs)(n.bL,{ref:t,className:(0,r.cn)("relative overflow-hidden",s),...l,children:[(0,a.jsx)(n.LM,{className:"h-full w-full rounded-[inherit]",children:i}),(0,a.jsx)(o,{}),(0,a.jsx)(n.OK,{})]})});l.displayName=n.bL.displayName;let o=i.forwardRef((e,t)=>{let{className:s,orientation:i="vertical",...l}=e;return(0,a.jsx)(n.VM,{ref:t,orientation:i,className:(0,r.cn)("flex touch-none select-none transition-colors","vertical"===i&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===i&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...l,children:(0,a.jsx)(n.lr,{className:"relative flex-1 rounded-full bg-border"})})});o.displayName=n.VM.displayName},7355:(e,t,s)=>{s.d(t,{b:()=>h});var a=s(9829),i=s(8209),n=s(373);class r{ensureInitialized(){this.initialized||(this.loadFromStorage(),this.initialized=!0)}addMessage(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text";this.ensureInitialized();let a="msg_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),i={id:a,roomId:e,content:t,type:s,timestamp:Date.now(),status:"pending",retryCount:0};return this.queue.push(i),this.saveToStorage(),a}getPendingMessages(e){return this.ensureInitialized(),this.queue.filter(t=>t.roomId===e&&("pending"===t.status||"sending"===t.status))}getAllPending(){return this.ensureInitialized(),this.queue.filter(e=>"pending"===e.status||"sending"===e.status)}updateStatus(e,t){this.ensureInitialized();let s=this.queue.find(t=>t.id===e);s&&(s.status=t,this.saveToStorage())}markAsSent(e){this.ensureInitialized(),this.queue=this.queue.filter(t=>t.id!==e),this.saveToStorage()}markAsFailed(e){this.ensureInitialized();let t=this.queue.find(t=>t.id===e);t&&(t.retryCount++,t.status=t.retryCount>=this.MAX_RETRIES?"failed":"pending",this.saveToStorage())}cleanup(){this.ensureInitialized();let e=Date.now()-864e5;this.queue=this.queue.filter(t=>!("failed"===t.status&&t.timestamp<e)),this.saveToStorage()}clearRoom(e){this.ensureInitialized(),this.queue=this.queue.filter(t=>t.roomId!==e),this.saveToStorage()}saveToStorage(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.queue))}catch(e){console.error("Failed to save message queue:",e)}}loadFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);e&&(this.queue=JSON.parse(e),this.cleanup())}catch(e){console.error("Failed to load message queue:",e),this.queue=[]}}constructor(){this.queue=[],this.STORAGE_KEY="chat_message_queue",this.MAX_RETRIES=3,this.initialized=!1,this.loadFromStorage(),this.initialized=!0}}let l=new r;class o{static getInstance(){return o.instance||(o.instance=new o),o.instance}startHealthCheck(e){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.healthCheckInterval=setInterval(()=>{e&&e.connected?(this.lastPingTime=Date.now(),e.emit("ping",this.lastPingTime),this.connectionStatus="connected"):(this.connectionStatus="disconnected",console.warn("Chat connection lost, attempting reconnect..."))},3e4)}stopHealthCheck(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null)}getConnectionStatus(){return{status:this.connectionStatus,lastPing:this.lastPingTime,isHealthy:"connected"===this.connectionStatus&&Date.now()-this.lastPingTime<6e4}}constructor(){this.healthCheckInterval=null,this.lastPingTime=0,this.connectionStatus="disconnected"}}let c=o.getInstance();class d{connect(){var e;if(null==(e=this.socket)?void 0:e.connected)return this.socket;let t=(0,i.getAuthToken)();if(!t)return console.warn("No auth token found, cannot connect to chat"),null;try{let e={auth:{token:t},transports:["websocket","polling"],timeout:2e4,forceNew:!0,withCredentials:!0,upgrade:!0,rememberUpgrade:!0};return e.secure=!0,e.rejectUnauthorized=!1,this.socket=(0,a.io)(n.f,e),this.socket.on("connect",()=>{console.log("Connected to chat server at:",n.f),this.reconnectAttempts=0,this.processQueuedMessages(),c.startHealthCheck(this.socket)}),this.socket.on("pong",e=>{if("number"==typeof e&&e>0){let t=Date.now()-e;t<1e4&&console.log("Chat server latency: ".concat(t,"ms"))}}),this.socket.on("message_delivered",e=>{let t=this.messageCallbacks.get(e.messageId);t&&(t("sent"),this.messageCallbacks.delete(e.messageId)),l.markAsSent(e.messageId)}),this.socket.on("message_failed",e=>{let t=this.messageCallbacks.get(e.messageId);t&&(t("failed"),this.messageCallbacks.delete(e.messageId)),l.markAsFailed(e.messageId)}),this.socket.on("disconnect",e=>{console.log("Disconnected from chat server:",e),c.stopHealthCheck()}),this.socket.on("connect_error",e=>{console.error("Chat connection error:",e),this.handleReconnect()}),this.socket}catch(e){return console.error("Failed to create socket connection:",e),null}}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,setTimeout(()=>{console.log("Attempting to reconnect... (".concat(this.reconnectAttempts,"/").concat(this.maxReconnectAttempts,")")),this.connect()},1e3*this.reconnectAttempts))}disconnect(){this.socket&&(c.stopHealthCheck(),this.socket.disconnect(),this.socket=null)}getHealthStatus(){return c.getConnectionStatus()}getSocket(){return this.socket}isConnected(){var e;return(null==(e=this.socket)?void 0:e.connected)||!1}sendMessage(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",a=arguments.length>3?arguments[3]:void 0,i=l.addMessage(e,t,s);return a&&this.messageCallbacks.set(i,a),this.isConnected()&&this.sendQueuedMessage({id:i,roomId:e,content:t,type:s,timestamp:Date.now(),status:"pending",retryCount:0}),i}async processQueuedMessages(){if(this.processingQueue||!this.isConnected())return;this.processingQueue=!0;let e=l.getAllPending();for(let t of(e.length>0&&console.log("Processing ".concat(e.length," queued messages")),e))try{await this.sendQueuedMessage(t),await new Promise(e=>setTimeout(e,200))}catch(e){console.error("Failed to send queued message:",e),l.markAsFailed(t.id)}this.processingQueue=!1,e.length>0&&console.log("Finished processing queued messages")}sendQueuedMessage(e){return new Promise((t,s)=>{if(!this.socket||!this.isConnected())return void s(Error("Socket not connected"));if(Date.now()-e.timestamp>864e5){console.log("Skipping old message:",e.id),l.markAsFailed(e.id),t();return}l.updateStatus(e.id,"sending");let a=setTimeout(()=>{l.markAsFailed(e.id),s(Error("Message send timeout"))},1e4),i=s=>{if(s.messageId===e.id){var r,l;clearTimeout(a),null==(r=this.socket)||r.off("message_delivered",i),null==(l=this.socket)||l.off("message_failed",n),t()}},n=t=>{if(t.messageId===e.id){var r,l;clearTimeout(a),null==(r=this.socket)||r.off("message_delivered",i),null==(l=this.socket)||l.off("message_failed",n),s(Error("Message send failed"))}};this.socket.on("message_delivered",i),this.socket.on("message_failed",n),this.socket.emit("send_message",{messageId:e.id,roomId:e.roomId,content:e.content,type:e.type})})}getPendingMessages(e){return l.getPendingMessages(e)}clearMessageQueue(e){l.clearRoom(e)}constructor(){this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.messageCallbacks=new Map,this.processingQueue=!1}}let h=new d}}]);