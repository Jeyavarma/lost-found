"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3582],{2180:(e,t,a)=>{a.d(t,{Bc:()=>i,ZI:()=>d,k$:()=>o,m_:()=>c});var s=a(5155),r=a(2115),n=a(7520),l=a(5016);let i=n.Kq,c=n.bL,o=n.l9,d=r.forwardRef((e,t)=>{let{className:a,sideOffset:r=4,...i}=e;return(0,s.jsx)(n.UC,{ref:t,sideOffset:r,className:(0,l.cn)("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...i})});d.displayName=n.UC.displayName},3582:(e,t,a)=>{a.d(t,{A:()=>T});var s=a(5155),r=a(2115),n=a(5937),l=a(3738),i=a(6191),c=a(3166),o=a(5998),d=a(4266),h=a(7624),u=a(7354),m=a(5229),x=a(6132),g=a(7003),f=a(3209),b=a(7812),p=a(2180),w=a(8209),j=a(4969),N=a(3637),v=a(4679),y=a(6170),C=a(3884),k=a(6651),A=a(373);function S(e){let{isOpen:t,onClose:a,onSelectUser:l,currentUserId:i}=e,[c,o]=(0,r.useState)(""),[d,h]=(0,r.useState)([]),[u,m]=(0,r.useState)(!1);(0,r.useEffect)(()=>{t&&c.length>=2?x():h([])},[c,t]);let x=async()=>{m(!0);try{let e=(0,w.getAuthToken)(),t=await fetch("".concat(A.f,"/api/users/search?q=").concat(encodeURIComponent(c)),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();h(e.filter(e=>e._id!==i))}}catch(e){console.error("Failed to search users:",e)}finally{m(!1)}};return(0,s.jsx)(v.lG,{open:t,onOpenChange:a,children:(0,s.jsxs)(v.Cf,{className:"max-w-md",children:[(0,s.jsx)(v.c7,{children:(0,s.jsxs)(v.L3,{className:"flex items-center gap-2",children:[(0,s.jsx)(n.A,{className:"w-5 h-5"}),"Start New Chat"]})}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(k.A,{className:"absolute left-3 top-3 w-4 h-4 text-gray-400"}),(0,s.jsx)(y.p,{placeholder:"Search users by name or email...",value:c,onChange:e=>o(e.target.value),className:"pl-10"})]}),c.length<2&&(0,s.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"Type at least 2 characters to search for users"}),u&&(0,s.jsx)("div",{className:"text-center py-4",children:(0,s.jsx)("div",{className:"animate-spin w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"})}),(0,s.jsx)("div",{className:"max-h-60 overflow-y-auto space-y-2",children:d.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer",onClick:()=>{l(e),a(),o(""),h([])},children:[(0,s.jsx)(C.eu,{className:"w-10 h-10",children:(0,s.jsx)(C.q5,{className:"bg-blue-100 text-blue-600",children:e.name.split(" ").map(e=>e[0]).join("").toUpperCase()})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 truncate",children:e.name}),(0,s.jsx)("p",{className:"text-sm text-gray-500 truncate",children:e.email}),(0,s.jsx)("p",{className:"text-xs text-gray-400 capitalize",children:e.role})]}),(0,s.jsx)(g.$,{size:"sm",variant:"outline",children:(0,s.jsx)(n.A,{className:"w-4 h-4"})})]},e._id))}),c.length>=2&&!u&&0===d.length&&(0,s.jsxs)("p",{className:"text-sm text-gray-500 text-center py-4",children:['No users found matching "',c,'"']})]})]})})}var z=a(7355);function T(){var e;let[t,a]=(0,r.useState)(!1),[v,y]=(0,r.useState)(!1),[C,k]=(0,r.useState)(!1),[T,$]=(0,r.useState)(null),[_,I]=(0,r.useState)(!1),[R,U]=(0,r.useState)(""),[B,E]=(0,r.useState)(!1),[M,O]=(0,r.useState)(0),[F,L]=(0,r.useState)({status:"disconnected",retryCount:0}),[q,P]=(0,r.useState)(!0),[Z,D]=(0,r.useState)(null),[G,J]=(0,r.useState)(!1),[K,W]=(0,r.useState)(!1),H=(0,r.useRef)(),Q=(0,r.useRef)();(0,r.useEffect)(()=>{let e=(0,w.isAuthenticated)();if(I(e),e){let e=(0,w.gL)();U((null==e?void 0:e.id)||""),V()}else J(!0);return()=>{H.current&&clearTimeout(H.current),Q.current&&clearTimeout(Q.current)}},[]);let V=(0,r.useCallback)(async()=>{try{D(null),await X(),await et(),ee()}catch(e){D("Failed to initialize chat system"),console.error("Chat initialization error:",e)}},[]),X=(0,r.useCallback)(async()=>{try{L(e=>({...e,status:"reconnecting"}));let e=z.b.connect();if(!e)throw Error("Failed to create socket connection");e.on("connect",()=>{L({status:"connected",lastConnected:Date.now(),retryCount:0}),D(null)}),e.on("disconnect",()=>{L(e=>({...e,status:"disconnected"})),Y()}),e.on("connect_error",e=>{L(e=>({...e,status:"error",retryCount:e.retryCount+1})),D("Connection failed: ".concat(e.message)),Y()}),e.on("new_message",e=>{e.senderId!==R&&(O(e=>e+1),ea(e))})}catch(e){L(e=>({...e,status:"error",retryCount:e.retryCount+1})),D("Connection failed"),Y()}},[R]),Y=(0,r.useCallback)(()=>{H.current&&clearTimeout(H.current),H.current=setTimeout(()=>{F.retryCount<5&&X()},Math.min(1e3*Math.pow(2,F.retryCount),3e4))},[F.retryCount,X]),ee=(0,r.useCallback)(()=>{Q.current&&clearTimeout(Q.current),Q.current=setInterval(()=>{let e=z.b.getSocket();(null==e?void 0:e.connected)?e.emit("ping"):L(e=>({...e,status:"disconnected"}))},3e4)},[]),et=(0,r.useCallback)(async()=>{try{let e=(0,w.getAuthToken)(),t=await fetch("".concat(A.f,"/api/chat/rooms"),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();E(e.length>0);let a=e.reduce((e,t)=>e+(t.unreadCount||0),0);O(a)}}catch(e){console.error("Failed to load chat rooms:",e)}},[]),ea=(0,r.useCallback)(e=>{q&&"Notification"in window&&"granted"===Notification.permission&&new Notification("New Message",{body:e.content,icon:"/favicon.ico",tag:"chat-message"})},[q]),es=(0,r.useCallback)(async()=>{"Notification"in window&&P("granted"===await Notification.requestPermission())},[]),er=(0,r.useCallback)(e=>{$(e),O(t=>Math.max(0,t-(e.unreadCount||0)))},[]),en=(0,r.useCallback)(()=>{$(null)},[]),el=(0,r.useCallback)(async e=>{try{let t=(0,w.getAuthToken)(),a=await fetch("".concat(A.f,"/api/chat/direct"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({otherUserId:e._id})});if(a.ok){let e=await a.json();$(e),et()}else D("Failed to start chat")}catch(e){D("Failed to start chat"),console.error("Start chat error:",e)}},[]),ei=(0,r.useCallback)(()=>{D("Please login to start chatting"),setTimeout(()=>D(null),3e3)},[]);return _||G||B||Z?(0,s.jsxs)(p.Bc,{children:[!t&&(0,s.jsxs)(p.m_,{children:[(0,s.jsx)(p.k$,{asChild:!0,children:(0,s.jsx)(g.$,{onClick:()=>{G?ei():(a(!0),es())},className:"fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg z-50 p-0 transition-all duration-300 ".concat("connected"===F.status?"bg-blue-600 hover:bg-blue-700":"bg-gray-500 hover:bg-gray-600"),"aria-label":"Open chat",children:(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(n.A,{className:"w-6 h-6 text-white"}),M>0&&(0,s.jsx)(b.E,{className:"absolute -top-2 -right-2 w-5 h-5 p-0 flex items-center justify-center bg-red-500 text-white text-xs","aria-label":"".concat(M," unread messages"),children:M>99?"99+":M}),"disconnected"===F.status&&(0,s.jsx)(l.A,{className:"absolute -bottom-1 -right-1 w-3 h-3 text-red-500 bg-white rounded-full"})]})})}),(0,s.jsx)(p.ZI,{side:"left",children:(0,s.jsx)("p",{children:G?"Login to chat":"connected"===F.status?"Open messages":"Chat offline"})})]}),t&&(0,s.jsx)("div",{className:"fixed bottom-6 right-6 z-50 transition-all duration-300 ".concat(C?"w-96 h-[600px] md:w-[500px] md:h-[700px]":v?"w-80 h-12":"w-80 h-96 md:w-96 md:h-[500px]"),children:(0,s.jsxs)(f.Zp,{className:"h-full shadow-xl border-2 flex flex-col",children:[(0,s.jsx)(f.aR,{className:"p-3 bg-blue-600 text-white rounded-t-lg flex-shrink-0",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,s.jsx)(f.ZB,{className:"text-sm font-medium truncate",children:T?(null==(e=T.itemId)?void 0:e.title)||"Direct Chat":"Messages"}),!T&&(0,s.jsx)(g.$,{variant:"ghost",size:"sm",onClick:()=>W(!0),className:"text-white hover:bg-blue-700 p-1 h-5 w-5","aria-label":"Start new chat",children:(0,s.jsx)(i.A,{className:"w-3 h-3"})}),(0,s.jsx)("div",{className:"flex items-center gap-1",children:"connected"===F.status?(0,s.jsx)(c.A,{className:"w-3 h-3 text-green-300"}):"reconnecting"===F.status?(0,s.jsx)("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):(0,s.jsx)(l.A,{className:"w-3 h-3 text-red-300"})}),(0,s.jsx)(g.$,{variant:"ghost",size:"sm",onClick:()=>P(!q),className:"text-white hover:bg-blue-700 p-1 h-5 w-5","aria-label":q?"Disable notifications":"Enable notifications",children:q?(0,s.jsx)(o.A,{className:"w-3 h-3"}):(0,s.jsx)(d.A,{className:"w-3 h-3"})})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 flex-shrink-0",children:[(0,s.jsx)(g.$,{variant:"ghost",size:"sm",onClick:()=>k(!C),className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":C?"Restore":"Maximize",children:C?(0,s.jsx)(h.A,{className:"w-3 h-3"}):(0,s.jsx)(u.A,{className:"w-3 h-3"})}),(0,s.jsx)(g.$,{variant:"ghost",size:"sm",onClick:()=>y(!v),className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":v?"Restore":"Minimize",children:(0,s.jsx)(h.A,{className:"w-3 h-3"})}),(0,s.jsx)(g.$,{variant:"ghost",size:"sm",onClick:()=>{a(!1),$(null),y(!1),k(!1)},className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":"Close chat",children:(0,s.jsx)(m.A,{className:"w-3 h-3"})})]})]})}),Z&&(0,s.jsxs)("div",{className:"p-2 bg-red-50 border-b border-red-200 flex items-center gap-2 flex-shrink-0",children:[(0,s.jsx)(x.A,{className:"w-4 h-4 text-red-500"}),(0,s.jsx)("span",{className:"text-sm text-red-700",children:Z}),(0,s.jsx)(g.$,{variant:"ghost",size:"sm",onClick:()=>D(null),className:"ml-auto p-1 h-5 w-5 text-red-500 hover:bg-red-100",children:(0,s.jsx)(m.A,{className:"w-3 h-3"})})]}),!v&&(0,s.jsx)(f.Wu,{className:"p-0 flex-1 overflow-hidden",children:G?(0,s.jsxs)("div",{className:"p-4 text-center",children:[(0,s.jsx)(n.A,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),(0,s.jsx)("h3",{className:"font-medium text-gray-900 mb-2",children:"Login Required"}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"Please login to start chatting with other users"}),(0,s.jsx)(g.$,{onClick:()=>window.location.href="/login",className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Login"})]}):T?(0,s.jsx)(N.A,{room:T,currentUserId:R,onBack:en}):(0,s.jsx)(j.A,{onSelectRoom:er,currentUserId:R})})]})}),(0,s.jsx)(S,{isOpen:K,onClose:()=>W(!1),onSelectUser:el,currentUserId:R})]}):null}}}]);