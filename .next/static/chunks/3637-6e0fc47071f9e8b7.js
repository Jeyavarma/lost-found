"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3637],{3637:(e,t,s)=>{s.d(t,{A:()=>w});var n=s(5155),a=s(2115),i=s(3209),r=s(7003),l=s(6170),o=s(7346),c=s(7812),d=s(3884),h=s(5626),u=s(501),m=s(5229),g=s(8085),x=s(7355),f=s(373),p=s(8209),v=s(1233);function w(e){let{room:t,onClose:s,onBack:w,currentUserId:j}=e,[k,y]=(0,a.useState)([]),[N,I]=(0,a.useState)([]),[b,S]=(0,a.useState)(""),[_,C]=(0,a.useState)(!0),[A,T]=(0,a.useState)(!1),[M,E]=(0,a.useState)(navigator.onLine),z=(0,a.useRef)(null),q=x.b.getSocket(),R=t.participants.find(e=>e.userId._id!==j);(0,a.useEffect)(()=>{D(),P(),q&&(q.emit("join_room",t._id),q.on("new_message",e=>{y(t=>[...t,e]),e.clientMessageId&&I(t=>t.filter(t=>t.id!==e.clientMessageId)),e.senderId._id!==j&&document.hidden&&v.tk.showChatNotification(e.senderId.name,e.content,t._id,t.itemId.title),Q()}),q.on("reaction_added",e=>{y(t=>t.map(t=>t._id===e.messageId?{...t,reactions:e.reactions}:t))}),q.on("reaction_removed",e=>{y(t=>t.map(t=>t._id===e.messageId?{...t,reactions:e.reactions}:t))}),q.on("messages_read",e=>{y(t=>t.map(t=>e.messageIds.includes(t._id)?{...t,readBy:[...t.readBy||[],{userId:e.userId,readAt:new Date().toISOString()}]}:t))}));let e=()=>E(!0),s=()=>E(!1);return window.addEventListener("online",e),window.addEventListener("offline",s),()=>{q&&(q.emit("leave_room",t._id),q.off("new_message")),window.removeEventListener("online",e),window.removeEventListener("offline",s)}},[t._id,q]),(0,a.useEffect)(()=>{Q()},[k]),(0,a.useEffect)(()=>{v.tk.initialize()},[]),(0,a.useEffect)(()=>{let e=k.filter(e=>{var t;return e.senderId._id!==j&&!(null==(t=e.readBy)?void 0:t.some(e=>e.userId===j))}).map(e=>e._id);e.length>0&&q&&q.emit("mark_read",{messageIds:e})},[k,j,q]);let D=async()=>{try{let e=(0,p.getAuthToken)(),s=await fetch("".concat(f.f,"/api/chat/room/").concat(t._id,"/messages"),{headers:{Authorization:"Bearer ".concat(e)}});if(s.ok){let e=await s.json();y(e)}}catch(e){console.error("Failed to load messages:",e)}finally{C(!1)}},P=()=>{I(x.b.getPendingMessages(t._id))},F=async()=>{if(b.trim()&&!A){T(!0);try{let e={id:x.b.sendMessage(t._id,b.trim(),"text",e=>{"failed"===e&&P()}),roomId:t._id,content:b.trim(),type:"text",timestamp:Date.now(),status:"pending",retryCount:0};I(t=>[...t,e]),S("")}catch(e){console.error("Failed to send message:",e)}finally{T(!1)}}},L=async()=>{if(R)try{let e=(0,p.getAuthToken)();(await fetch("".concat(f.f,"/api/chat/block/").concat(R.userId._id),{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({reason:"Blocked from chat"})})).ok&&(alert("User blocked successfully"),null==s||s())}catch(e){console.error("Block user error:",e)}},B=e=>{var t;return(null==(t=e.readBy)?void 0:t.some(e=>e.userId!==j))||!1},Q=()=>{var e;null==(e=z.current)||e.scrollIntoView({behavior:"smooth"})};return(0,n.jsxs)(i.Zp,{className:"h-full flex flex-col",children:[(0,n.jsx)(i.aR,{className:"pb-3 border-b",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)(r.$,{variant:"ghost",size:"sm",onClick:w||s,children:(0,n.jsx)(h.A,{className:"w-4 h-4"})}),t.itemId.imageUrl&&(0,n.jsx)("img",{src:t.itemId.imageUrl,alt:t.itemId.title,className:"w-10 h-10 rounded-lg object-cover"}),(0,n.jsxs)("div",{children:[(0,n.jsx)(i.ZB,{className:"text-lg",children:t.itemId.title}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,n.jsx)(c.E,{variant:"outline",children:t.itemId.category}),(0,n.jsx)("span",{children:"•"}),(0,n.jsxs)("span",{children:["with ",null==R?void 0:R.userId.name]})]})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(r.$,{variant:"ghost",size:"sm",onClick:L,title:"Block User",children:(0,n.jsx)(u.A,{className:"w-4 h-4"})}),s&&(0,n.jsx)(r.$,{variant:"ghost",size:"sm",onClick:s,children:(0,n.jsx)(m.A,{className:"w-4 h-4"})})]})]})}),(0,n.jsxs)(i.Wu,{className:"flex-1 p-0",children:[(0,n.jsx)(o.F,{className:"h-96 p-4",children:_?(0,n.jsx)("div",{className:"flex justify-center py-8",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})}):(0,n.jsxs)("div",{className:"space-y-4",children:[k.map(e=>{let t=e.senderId._id===j;return(0,n.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,n.jsxs)("div",{className:"flex items-start gap-2 max-w-[70%] ".concat(t?"flex-row-reverse":""),children:[!t&&(0,n.jsx)(d.eu,{className:"w-8 h-8",children:(0,n.jsx)(d.q5,{className:"text-xs",children:e.senderId.name.charAt(0)})}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"rounded-lg px-3 py-2 ".concat(t?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:[(0,n.jsx)("p",{className:"text-sm",children:e.content}),(0,n.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,n.jsx)("p",{className:"text-xs ".concat(t?"text-blue-100":"text-gray-500"),children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),t&&(0,n.jsx)("span",{className:"text-xs ".concat(B(e)?"text-blue-200":"text-blue-300"),children:B(e)?"✓✓":"✓"})]})]}),e.reactions&&e.reactions.length>0&&(0,n.jsx)("div",{className:"flex gap-1 mt-1",children:e.reactions.map((e,t)=>(0,n.jsx)("span",{className:"text-xs bg-gray-100 px-1 rounded",children:e.emoji},t))})]})]})},e._id)}),N.map(e=>(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)("div",{className:"flex items-start gap-2 max-w-[70%] flex-row-reverse",children:(0,n.jsxs)("div",{className:"bg-blue-400 text-white rounded-lg px-3 py-2 opacity-70",children:[(0,n.jsx)("p",{className:"text-sm",children:e.content}),(0,n.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[(0,n.jsx)("p",{className:"text-xs text-blue-100",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,n.jsxs)("span",{className:"text-xs text-blue-200",children:["pending"===e.status&&"⏳","sending"===e.status&&"\uD83D\uDCE4","failed"===e.status&&"❌"]})]})]})})},e.id)),(0,n.jsx)("div",{ref:z})]})}),(0,n.jsxs)("div",{className:"border-t p-4",children:[!M&&(0,n.jsx)("div",{className:"mb-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"\uD83D\uDCE1 You're offline. Messages will be sent when connection is restored."}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(l.p,{placeholder:M?"Type a message...":"Type a message (will send when online)...",value:b,onChange:e=>S(e.target.value),onKeyPress:e=>"Enter"===e.key&&F(),disabled:A,className:"flex-1"}),(0,n.jsx)(r.$,{onClick:F,disabled:!b.trim()||A,size:"sm",children:A?(0,n.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):(0,n.jsx)(g.A,{className:"w-4 h-4"})})]})]})]})]})}},3884:(e,t,s)=>{s.d(t,{eu:()=>l,q5:()=>o});var n=s(5155),a=s(2115),i=s(7870),r=s(5016);let l=a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,n.jsx)(i.bL,{ref:t,className:(0,r.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...a})});l.displayName=i.bL.displayName,a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,n.jsx)(i._V,{ref:t,className:(0,r.cn)("aspect-square h-full w-full",s),...a})}).displayName=i._V.displayName;let o=a.forwardRef((e,t)=>{let{className:s,...a}=e;return(0,n.jsx)(i.H4,{ref:t,className:(0,r.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...a})});o.displayName=i.H4.displayName},7346:(e,t,s)=>{s.d(t,{F:()=>l});var n=s(5155),a=s(2115),i=s(9034),r=s(5016);let l=a.forwardRef((e,t)=>{let{className:s,children:a,...l}=e;return(0,n.jsxs)(i.bL,{ref:t,className:(0,r.cn)("relative overflow-hidden",s),...l,children:[(0,n.jsx)(i.LM,{className:"h-full w-full rounded-[inherit]",children:a}),(0,n.jsx)(o,{}),(0,n.jsx)(i.OK,{})]})});l.displayName=i.bL.displayName;let o=a.forwardRef((e,t)=>{let{className:s,orientation:a="vertical",...l}=e;return(0,n.jsx)(i.VM,{ref:t,orientation:a,className:(0,r.cn)("flex touch-none select-none transition-colors","vertical"===a&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===a&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...l,children:(0,n.jsx)(i.lr,{className:"relative flex-1 rounded-full bg-border"})})});o.displayName=i.VM.displayName},7355:(e,t,s)=>{s.d(t,{b:()=>h});var n=s(9829),a=s(8209),i=s(373);class r{ensureInitialized(){this.initialized||(this.loadFromStorage(),this.initialized=!0)}addMessage(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text";this.ensureInitialized();let n="msg_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),a={id:n,roomId:e,content:t,type:s,timestamp:Date.now(),status:"pending",retryCount:0};return this.queue.push(a),this.saveToStorage(),n}getPendingMessages(e){return this.ensureInitialized(),this.queue.filter(t=>t.roomId===e&&("pending"===t.status||"sending"===t.status))}getAllPending(){return this.ensureInitialized(),this.queue.filter(e=>"pending"===e.status||"sending"===e.status)}updateStatus(e,t){this.ensureInitialized();let s=this.queue.find(t=>t.id===e);s&&(s.status=t,this.saveToStorage())}markAsSent(e){this.ensureInitialized(),this.queue=this.queue.filter(t=>t.id!==e),this.saveToStorage()}markAsFailed(e){this.ensureInitialized();let t=this.queue.find(t=>t.id===e);t&&(t.retryCount++,t.status=t.retryCount>=this.MAX_RETRIES?"failed":"pending",this.saveToStorage())}cleanup(){this.ensureInitialized();let e=Date.now()-864e5;this.queue=this.queue.filter(t=>!("failed"===t.status&&t.timestamp<e)),this.saveToStorage()}clearRoom(e){this.ensureInitialized(),this.queue=this.queue.filter(t=>t.roomId!==e),this.saveToStorage()}saveToStorage(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.queue))}catch(e){console.error("Failed to save message queue:",e)}}loadFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);e&&(this.queue=JSON.parse(e),this.cleanup())}catch(e){console.error("Failed to load message queue:",e),this.queue=[]}}constructor(){this.queue=[],this.STORAGE_KEY="chat_message_queue",this.MAX_RETRIES=3,this.initialized=!1,this.loadFromStorage(),this.initialized=!0}}let l=new r;class o{static getInstance(){return o.instance||(o.instance=new o),o.instance}startHealthCheck(e){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.healthCheckInterval=setInterval(()=>{e&&e.connected?(this.lastPingTime=Date.now(),e.emit("ping",this.lastPingTime),this.connectionStatus="connected"):(this.connectionStatus="disconnected",console.warn("Chat connection lost, attempting reconnect..."))},3e4)}stopHealthCheck(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null)}getConnectionStatus(){return{status:this.connectionStatus,lastPing:this.lastPingTime,isHealthy:"connected"===this.connectionStatus&&Date.now()-this.lastPingTime<6e4}}constructor(){this.healthCheckInterval=null,this.lastPingTime=0,this.connectionStatus="disconnected"}}let c=o.getInstance();class d{connect(){var e;if(null==(e=this.socket)?void 0:e.connected)return this.socket;let t=(0,a.getAuthToken)();if(!t)return console.warn("No auth token found, cannot connect to chat"),null;try{let e={auth:{token:t},transports:["websocket","polling"],timeout:2e4,forceNew:!0,withCredentials:!0,upgrade:!0,rememberUpgrade:!0};return e.secure=!0,e.rejectUnauthorized=!1,this.socket=(0,n.io)(i.f,e),this.socket.on("connect",()=>{console.log("Connected to chat server at:",i.f),this.reconnectAttempts=0,this.processQueuedMessages(),c.startHealthCheck(this.socket)}),this.socket.on("pong",e=>{let t=Date.now()-e;console.log("Chat server latency: ".concat(t,"ms"))}),this.socket.on("message_delivered",e=>{let t=this.messageCallbacks.get(e.messageId);t&&(t("sent"),this.messageCallbacks.delete(e.messageId)),l.markAsSent(e.messageId)}),this.socket.on("message_failed",e=>{let t=this.messageCallbacks.get(e.messageId);t&&(t("failed"),this.messageCallbacks.delete(e.messageId)),l.markAsFailed(e.messageId)}),this.socket.on("disconnect",e=>{console.log("Disconnected from chat server:",e),c.stopHealthCheck()}),this.socket.on("connect_error",e=>{console.error("Chat connection error:",e),this.handleReconnect()}),this.socket}catch(e){return console.error("Failed to create socket connection:",e),null}}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,setTimeout(()=>{console.log("Attempting to reconnect... (".concat(this.reconnectAttempts,"/").concat(this.maxReconnectAttempts,")")),this.connect()},1e3*this.reconnectAttempts))}disconnect(){this.socket&&(c.stopHealthCheck(),this.socket.disconnect(),this.socket=null)}getHealthStatus(){return c.getConnectionStatus()}getSocket(){return this.socket}isConnected(){var e;return(null==(e=this.socket)?void 0:e.connected)||!1}sendMessage(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",n=arguments.length>3?arguments[3]:void 0,a=l.addMessage(e,t,s);return n&&this.messageCallbacks.set(a,n),this.isConnected()&&this.sendQueuedMessage({id:a,roomId:e,content:t,type:s,timestamp:Date.now(),status:"pending",retryCount:0}),a}async processQueuedMessages(){if(!this.processingQueue&&this.isConnected()){for(let e of(this.processingQueue=!0,l.getAllPending()))await this.sendQueuedMessage(e),await new Promise(e=>setTimeout(e,100));this.processingQueue=!1}}sendQueuedMessage(e){this.socket&&this.isConnected()&&(l.updateStatus(e.id,"sending"),this.socket.emit("send_message",{messageId:e.id,roomId:e.roomId,content:e.content,type:e.type}))}getPendingMessages(e){return l.getPendingMessages(e)}clearMessageQueue(e){l.clearRoom(e)}constructor(){this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.messageCallbacks=new Map,this.processingQueue=!1}}let h=new d}}]);