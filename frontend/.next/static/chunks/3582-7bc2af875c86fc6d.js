"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3582],{2180:(e,t,s)=>{s.d(t,{Bc:()=>o,ZI:()=>d,k$:()=>c,m_:()=>l});var a=s(5155),r=s(2115),n=s(7520),i=s(5016);let o=n.Kq,l=n.bL,c=n.l9,d=r.forwardRef((e,t)=>{let{className:s,sideOffset:r=4,...o}=e;return(0,a.jsx)(n.UC,{ref:t,sideOffset:r,className:(0,i.cn)("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...o})});d.displayName=n.UC.displayName},3582:(e,t,s)=>{s.d(t,{A:()=>I});var a=s(5155),r=s(2115),n=s(5937),i=s(3738),o=s(6191),l=s(3166),c=s(5998),d=s(4266),h=s(7624),m=s(7354),u=s(5229),x=s(6132),f=s(7003),w=s(3209),p=s(7812),g=s(2180),b=s(8209),j=s(4969),N=s(3637),y=s(4679),v=s(6170),C=s(3884),k=s(6651),A=s(373);function S(e){let{isOpen:t,onClose:s,onSelectUser:i,currentUserId:o}=e,[l,c]=(0,r.useState)(""),[d,h]=(0,r.useState)([]),[m,u]=(0,r.useState)(!1);(0,r.useEffect)(()=>{t&&l.length>=2?x():h([])},[l,t]);let x=async()=>{u(!0);try{let e=(0,b.getAuthToken)(),t=await fetch("".concat(A.f,"/api/users/search?q=").concat(encodeURIComponent(l)),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();h(e.filter(e=>e._id!==o))}}catch(e){console.error("Failed to search users:",e)}finally{u(!1)}};return(0,a.jsx)(y.lG,{open:t,onOpenChange:s,children:(0,a.jsxs)(y.Cf,{className:"max-w-md",children:[(0,a.jsx)(y.c7,{children:(0,a.jsxs)(y.L3,{className:"flex items-center gap-2",children:[(0,a.jsx)(n.A,{className:"w-5 h-5"}),"Start New Chat"]})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(k.A,{className:"absolute left-3 top-3 w-4 h-4 text-gray-400"}),(0,a.jsx)(v.p,{placeholder:"Search users by name or email...",value:l,onChange:e=>c(e.target.value),className:"pl-10"})]}),l.length<2&&(0,a.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"Type at least 2 characters to search for users"}),m&&(0,a.jsx)("div",{className:"text-center py-4",children:(0,a.jsx)("div",{className:"animate-spin w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto"})}),(0,a.jsx)("div",{className:"max-h-60 overflow-y-auto space-y-2",children:d.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer",onClick:()=>{i(e),s(),c(""),h([])},children:[(0,a.jsx)(C.eu,{className:"w-10 h-10",children:(0,a.jsx)(C.q5,{className:"bg-blue-100 text-blue-600",children:e.name.split(" ").map(e=>e[0]).join("").toUpperCase()})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 truncate",children:e.name}),(0,a.jsx)("p",{className:"text-sm text-gray-500 truncate",children:e.email}),(0,a.jsx)("p",{className:"text-xs text-gray-400 capitalize",children:e.role})]}),(0,a.jsx)(f.$,{size:"sm",variant:"outline",children:(0,a.jsx)(n.A,{className:"w-4 h-4"})})]},e._id))}),l.length>=2&&!m&&0===d.length&&(0,a.jsxs)("p",{className:"text-sm text-gray-500 text-center py-4",children:['No users found matching "',l,'"']})]})]})})}var z=s(7355);function I(){var e;let[t,s]=(0,r.useState)(!1),[y,v]=(0,r.useState)(!1),[C,k]=(0,r.useState)(!1),[I,E]=(0,r.useState)(null),[T,_]=(0,r.useState)(!1),[$,R]=(0,r.useState)(""),[U,F]=(0,r.useState)(!1),[L,q]=(0,r.useState)(0),[B,M]=(0,r.useState)({status:"disconnected",retryCount:0}),[O,P]=(0,r.useState)(!0),[Z,D]=(0,r.useState)(null),[G,J]=(0,r.useState)(!1),[K,W]=(0,r.useState)(!1),H=(0,r.useRef)(),Q=(0,r.useRef)();(0,r.useEffect)(()=>{let e=(0,b.isAuthenticated)();if(_(e),e){let e=(0,b.gL)();R((null==e?void 0:e.id)||""),V()}else J(!0);let t=e=>{let{room:t}=e.detail;t&&(E(t),s(!0),et())};window.addEventListener("openChat",t);let a=setInterval(()=>{let e=(0,b.isAuthenticated)();e!==T&&(e?(_(!0),J(!1),V()):(z.b.disconnect(),_(!1),J(!0),s(!1)))},3e4);return()=>{window.removeEventListener("openChat",t),clearInterval(a),H.current&&clearTimeout(H.current),Q.current&&clearTimeout(Q.current),z.b.disconnect()}},[]);let V=(0,r.useCallback)(async()=>{try{if(D(null),!(0,b.isAuthenticated)()){_(!1),J(!0);return}await X(),await et(),ee()}catch(e){D("Failed to initialize chat system"),console.error("Chat initialization error:",e)}},[]),X=(0,r.useCallback)(async()=>{try{M(e=>({...e,status:"reconnecting"}));let e=z.b.connect();if(!e)throw Error("Failed to create socket connection");e.on("connect",()=>{console.log("Enhanced chat connected"),M({status:"connected",lastConnected:Date.now(),retryCount:0}),D(null)}),e.on("disconnect",e=>{console.log("Enhanced chat disconnected:",e),M(e=>({...e,status:"disconnected"})),"io client disconnect"!==e&&Y()}),e.on("connect_error",e=>{console.error("Enhanced chat connection error:",e),M(e=>({...e,status:"error",retryCount:e.retryCount+1})),D("Connection failed: ".concat(e.message)),Y()}),e.on("new_message",e=>{e.senderId!==$&&(q(e=>e+1),es(e))})}catch(e){M(e=>({...e,status:"error",retryCount:e.retryCount+1})),D("Connection failed"),Y()}},[$]),Y=(0,r.useCallback)(()=>{H.current&&clearTimeout(H.current),H.current=setTimeout(()=>{B.retryCount<5&&X()},Math.min(1e3*Math.pow(2,B.retryCount),3e4))},[B.retryCount,X]),ee=(0,r.useCallback)(()=>{Q.current&&clearTimeout(Q.current),Q.current=setInterval(()=>{let e=z.b.getSocket();(null==e?void 0:e.connected)?e.emit("ping"):M(e=>({...e,status:"disconnected"}))},3e4)},[]),et=(0,r.useCallback)(async()=>{try{let e=(0,b.getAuthToken)(),t=await fetch("".concat(A.f,"/api/chat/rooms"),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json(),s=[];Array.isArray(e)?s=e.filter(e=>e&&e._id):e&&"object"==typeof e&&Array.isArray(e.rooms)?s=e.rooms.filter(e=>e&&e._id):(console.warn("Invalid chat rooms data format:",e),s=[]),F(s.length>0);let a=s.reduce((e,t)=>e+(t.unreadCount||0),0);q(a)}else console.warn("Failed to fetch chat rooms:",t.status),F(!1),q(0)}catch(e){console.error("Failed to load chat rooms:",e),F(!1),q(0)}},[]),es=(0,r.useCallback)(e=>{if(O&&"Notification"in window&&"granted"===Notification.permission)try{let t=new Notification("New Message",{body:e.content.substring(0,100),icon:"/favicon.ico",tag:"chat-message",requireInteraction:!1,silent:!1});setTimeout(()=>t.close(),5e3),t.onclick=()=>{window.focus(),s(!0),t.close()}}catch(e){console.error("Failed to show notification:",e)}},[O]),ea=(0,r.useCallback)(async()=>{if(!("Notification"in window))return void console.log("Notifications not supported");if("granted"===Notification.permission)return void P(!0);if("denied"===Notification.permission)return void P(!1);try{let e=await Notification.requestPermission();P("granted"===e),"denied"===e&&console.log("Notification permission denied")}catch(e){console.error("Error requesting notification permission:",e),P(!1)}},[]),er=(0,r.useCallback)(e=>{E(e),q(t=>Math.max(0,t-(e.unreadCount||0)))},[]),en=(0,r.useCallback)(()=>{E(null)},[]),ei=(0,r.useCallback)(async e=>{try{let t=(0,b.getAuthToken)(),s=await fetch("".concat(A.f,"/api/chat/direct"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({otherUserId:e._id})});if(s.ok){let e=await s.json();E(e),et()}else D("Failed to start chat")}catch(e){D("Failed to start chat"),console.error("Start chat error:",e)}},[]),eo=(0,r.useCallback)(()=>{D("Please login to start chatting"),setTimeout(()=>D(null),3e3)},[]);return T||G||U||Z?(0,a.jsxs)(g.Bc,{children:[!t&&(0,a.jsxs)(g.m_,{children:[(0,a.jsx)(g.k$,{asChild:!0,children:(0,a.jsx)(f.$,{onClick:()=>{G?eo():(s(!0),ea())},className:"fixed bottom-4 right-4 sm:bottom-6 sm:right-6 w-12 h-12 sm:w-14 sm:h-14 rounded-full shadow-xl z-50 p-0 transition-all duration-300 border-2 border-white touch-manipulation text-white",style:{backgroundColor:"connected"===B.status?"#2563eb":"#4b5563",opacity:1},"aria-label":"Open chat",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(n.A,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"}),L>0&&(0,a.jsx)(p.E,{className:"absolute -top-2 -right-2 w-5 h-5 p-0 flex items-center justify-center bg-red-500 text-white text-xs","aria-label":"".concat(L," unread messages"),children:L>99?"99+":L}),"disconnected"===B.status&&(0,a.jsx)(i.A,{className:"absolute -bottom-1 -right-1 w-3 h-3 text-red-500 bg-white rounded-full"})]})})}),(0,a.jsx)(g.ZI,{side:"left",children:(0,a.jsx)("p",{children:G?"Login to chat":"connected"===B.status?"Open messages":"Chat offline"})})]}),t&&(0,a.jsx)("div",{className:"fixed bottom-6 right-6 z-50 transition-all duration-300 ".concat(C?"w-full h-full sm:w-96 sm:h-[600px] md:w-[500px] md:h-[700px] fixed sm:relative inset-0 sm:inset-auto":y?"w-72 sm:w-80 h-12":"w-full h-[400px] sm:w-80 sm:h-96 md:w-96 md:h-[500px] max-w-sm sm:max-w-none"),children:(0,a.jsxs)(w.Zp,{className:"h-full shadow-xl border-2 flex flex-col",style:{backgroundColor:"#ffffff",opacity:1},children:[(0,a.jsx)(w.aR,{className:"p-3 bg-blue-600 text-white rounded-t-lg flex-shrink-0",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,a.jsx)(w.ZB,{className:"text-sm font-medium truncate",children:I?(null==(e=I.itemId)?void 0:e.title)||"Direct Chat":"Messages"}),!I&&(0,a.jsx)(f.$,{variant:"ghost",size:"sm",onClick:()=>W(!0),className:"text-white hover:bg-blue-700 p-1 h-5 w-5","aria-label":"Start new chat",children:(0,a.jsx)(o.A,{className:"w-3 h-3"})}),(0,a.jsx)("div",{className:"flex items-center gap-1",children:"connected"===B.status?(0,a.jsx)(l.A,{className:"w-3 h-3 text-green-300"}):"reconnecting"===B.status?(0,a.jsx)("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):(0,a.jsx)(i.A,{className:"w-3 h-3 text-red-300"})}),(0,a.jsx)(f.$,{variant:"ghost",size:"sm",onClick:()=>P(!O),className:"text-white hover:bg-blue-700 p-1 h-5 w-5","aria-label":O?"Disable notifications":"Enable notifications",children:O?(0,a.jsx)(c.A,{className:"w-3 h-3"}):(0,a.jsx)(d.A,{className:"w-3 h-3"})})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 flex-shrink-0",children:[(0,a.jsx)(f.$,{variant:"ghost",size:"sm",onClick:()=>k(!C),className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":C?"Restore":"Maximize",children:C?(0,a.jsx)(h.A,{className:"w-3 h-3"}):(0,a.jsx)(m.A,{className:"w-3 h-3"})}),(0,a.jsx)(f.$,{variant:"ghost",size:"sm",onClick:()=>v(!y),className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":y?"Restore":"Minimize",children:(0,a.jsx)(h.A,{className:"w-3 h-3"})}),(0,a.jsx)(f.$,{variant:"ghost",size:"sm",onClick:()=>{s(!1),E(null),v(!1),k(!1)},className:"text-white hover:bg-blue-700 p-1 h-6 w-6","aria-label":"Close chat",children:(0,a.jsx)(u.A,{className:"w-3 h-3"})})]})]})}),Z&&(0,a.jsxs)("div",{className:"p-2 bg-red-50 border-b border-red-200 flex items-center gap-2 flex-shrink-0",children:[(0,a.jsx)(x.A,{className:"w-4 h-4 text-red-500"}),(0,a.jsx)("span",{className:"text-sm text-red-700",children:Z}),(0,a.jsx)(f.$,{variant:"ghost",size:"sm",onClick:()=>D(null),className:"ml-auto p-1 h-5 w-5 text-red-500 hover:bg-red-100",children:(0,a.jsx)(u.A,{className:"w-3 h-3"})})]}),!y&&(0,a.jsx)(w.Wu,{className:"p-0 flex-1 overflow-hidden",children:G?(0,a.jsxs)("div",{className:"p-4 text-center",children:[(0,a.jsx)(n.A,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"font-medium text-gray-900 mb-2",children:"Login Required"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"Please login to start chatting with other users"}),(0,a.jsx)(f.$,{onClick:()=>window.location.href="/login",className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Login"})]}):I?(0,a.jsx)(N.A,{room:I,currentUserId:$,onBack:en}):(0,a.jsx)(j.A,{onSelectRoom:er,currentUserId:$})})]})}),(0,a.jsx)(S,{isOpen:K,onClose:()=>W(!1),onSelectUser:ei,currentUserId:$})]}):null}}}]);